<?php
/********************************************************************************
*
* ????? : AGS_pay_ing.php
* ???????????? : 2017/11/30
*
* ????? ??????? ???? ???????????? ????.
*
* Copyright NICEPayments.Co.,Ltd. All rights reserved.
*
*
*  ?? ??????? ??
*  1.  "|"(??????) ???? ??????? ?? ??????? ?????? ???????? ???? ??????? "|"?? ???????
*   ?????? ?????????? ??????? ??????.(???? ?????? ???? ???? ???? ????)
********************************************************************************/
	
	
	/****************************************************************************
	*
	* [1] ???????(AGSLib.php)?? ?????? ????.
	*
	****************************************************************************/
	require ("./lib/AGSLib.php");


	/****************************************************************************
	*
	* [2]. agspay4.0 ??????? ?ν?????? ????????.
	*
	****************************************************************************/
	$agspay = new agspay40;



	/****************************************************************************
	*
	* [3] AGS_pay.html ?? ???? ?????? ?????
	*
	****************************************************************************/

	/*??????*/
	//$agspay->SetValue("AgsPayHome","C:/htdocs/agspay");			//???????? ??????? ???? (?????? ?°? ????)
	$agspay->SetValue("AgsPayHome","/data2/local_docs/agspay40/php");			//???????? ??????? ???? (?????? ?°? ????)
	$agspay->SetValue("StoreId",trim($_POST["StoreId"]));		//?????????
	$agspay->SetValue("log","true");							//true : ?α???, false : ?α??????.
	$agspay->SetValue("logLevel","INFO");						//?α???? : DEBUG, INFO, WARN, ERROR, FATAL (??? ????????? ?α?? ????)
	$agspay->SetValue("UseNetCancel","true");					//true : ????? ???. false: ????? ????
	$agspay->SetValue("Type", "Pay");							//??????(???????)
	$agspay->SetValue("RecvLen", 7);							//???? ??????(????) ?? ?????? 6 ??? 7 ????. 
	
	$agspay->SetValue("AuthTy",trim($_POST["AuthTy"]));			//????????
	$agspay->SetValue("SubTy",trim($_POST["SubTy"]));			//???????????
	$agspay->SetValue("OrdNo",trim($_POST["OrdNo"]));			//??????
	$agspay->SetValue("Amt",trim($_POST["Amt"]));				//???
	$agspay->SetValue("UserEmail",trim($_POST["UserEmail"]));	//??????????
	$agspay->SetValue("ProdNm",trim($_POST["ProdNm"]));			//?????
	$AGS_HASHDATA 		= trim( $_POST["AGS_HASHDATA"] );		//???? HASHDATA

	/*??????&?????????*/
	$agspay->SetValue("MallUrl",trim($_POST["MallUrl"]));		//MallUrl(?????????) - ???? ?????? ??????????
	$agspay->SetValue("UserId",trim($_POST["UserId"]));			//????????


	/*????????*/
	$agspay->SetValue("OrdNm",trim($_POST["OrdNm"]));			//??????
	$agspay->SetValue("OrdPhone",trim($_POST["OrdPhone"]));		//?????????
	$agspay->SetValue("OrdAddr",trim($_POST["OrdAddr"]));		//???????? ??????????
	$agspay->SetValue("RcpNm",trim($_POST["RcpNm"]));			//???????
	$agspay->SetValue("RcpPhone",trim($_POST["RcpPhone"]));		//??????????
	$agspay->SetValue("DlvAddr",trim($_POST["DlvAddr"]));		//????????
	$agspay->SetValue("Remark",trim($_POST["Remark"]));			//???
	$agspay->SetValue("DeviId",trim($_POST["DeviId"]));			//?????????
	$agspay->SetValue("AuthYn",trim($_POST["AuthYn"]));			//????????
	$agspay->SetValue("Instmt",trim($_POST["Instmt"]));			//????????
	$agspay->SetValue("UserIp",$_SERVER["REMOTE_ADDR"]);		//??? IP

	/*??????(ISP)*/
	$agspay->SetValue("partial_mm",trim($_POST["partial_mm"]));		//?????α?
	$agspay->SetValue("noIntMonth",trim($_POST["noIntMonth"]));		//????????α?
	$agspay->SetValue("KVP_CURRENCY",trim($_POST["KVP_CURRENCY"]));	//KVP_??????
	$agspay->SetValue("KVP_CARDCODE",trim($_POST["KVP_CARDCODE"]));	//KVP_???????
	$agspay->SetValue("KVP_SESSIONKEY",$_POST["KVP_SESSIONKEY"]);	//KVP_SESSIONKEY
	$agspay->SetValue("KVP_ENCDATA",$_POST["KVP_ENCDATA"]);			//KVP_ENCDATA
	$agspay->SetValue("KVP_CONAME",trim($_POST["KVP_CONAME"]));		//KVP_????
	$agspay->SetValue("KVP_NOINT",trim($_POST["KVP_NOINT"]));		//KVP_??????=1 ???=0
	$agspay->SetValue("KVP_QUOTA",trim($_POST["KVP_QUOTA"]));		//KVP_??????

	/*??????(???)*/
	$agspay->SetValue("CardNo",trim($_POST["CardNo"]));			//?????
	$agspay->SetValue("MPI_CAVV",$_POST["MPI_CAVV"]);			//MPI_CAVV
	$agspay->SetValue("MPI_ECI",$_POST["MPI_ECI"]);				//MPI_ECI
	$agspay->SetValue("MPI_MD64",$_POST["MPI_MD64"]);			//MPI_MD64

	/*??????(???)*/
	$agspay->SetValue("ExpMon",trim($_POST["ExpMon"]));				//?????(??)
	$agspay->SetValue("ExpYear",trim($_POST["ExpYear"]));			//?????(??)
	$agspay->SetValue("Passwd",trim($_POST["Passwd"]));				//??й??
	$agspay->SetValue("SocId",trim($_POST["SocId"]));				//??ε????/?????????

	/*??????????*/
	$agspay->SetValue("ICHE_OUTBANKNAME",trim($_POST["ICHE_OUTBANKNAME"]));		//????????
	$agspay->SetValue("ICHE_OUTACCTNO",trim($_POST["ICHE_OUTACCTNO"]));			//??????¹??
	$agspay->SetValue("ICHE_OUTBANKMASTER",trim($_POST["ICHE_OUTBANKMASTER"]));	//??????¼?????
	$agspay->SetValue("ICHE_AMOUNT",trim($_POST["ICHE_AMOUNT"]));				//??????

	/*????????*/
	$agspay->SetValue("HP_SERVERINFO",trim($_POST["HP_SERVERINFO"]));	//SERVER_INFO(?????????)
	$agspay->SetValue("HP_HANDPHONE",trim($_POST["HP_HANDPHONE"]));		//HANDPHONE(?????????)
	$agspay->SetValue("HP_COMPANY",trim($_POST["HP_COMPANY"]));			//COMPANY(?????????)
	$agspay->SetValue("HP_ID",trim($_POST["HP_ID"]));					//HP_ID(?????????)
	$agspay->SetValue("HP_SUBID",trim($_POST["HP_SUBID"]));				//HP_SUBID(?????????)
	$agspay->SetValue("HP_UNITType",trim($_POST["HP_UNITType"]));		//HP_UNITType(?????????)
	$agspay->SetValue("HP_IDEN",trim($_POST["HP_IDEN"]));				//HP_IDEN(?????????)
	$agspay->SetValue("HP_IPADDR",trim($_POST["HP_IPADDR"]));			//HP_IPADDR(?????????)

	/*ARS???*/
	$agspay->SetValue("ARS_NAME",trim($_POST["ARS_NAME"]));				//ARS_NAME(ARS????)
	$agspay->SetValue("ARS_PHONE",trim($_POST["ARS_PHONE"]));			//ARS_PHONE(ARS????)

	/*?????????*/
	$agspay->SetValue("VIRTUAL_CENTERCD",trim($_POST["VIRTUAL_CENTERCD"]));	//???????(???????)
	$agspay->SetValue("VIRTUAL_DEPODT",trim($_POST["VIRTUAL_DEPODT"]));		//????????(???????)
	$agspay->SetValue("ZuminCode",trim($_POST["ZuminCode"]));				//??ι??(???????)
	$agspay->SetValue("MallPage",trim($_POST["MallPage"]));					//???? ??/??? ?? ??????(???????)
	$agspay->SetValue("VIRTUAL_NO",trim($_POST["VIRTUAL_NO"]));				//??????¹??(???????)

	/*??????λ??*/
	$agspay->SetValue("ES_SENDNO",trim($_POST["ES_SENDNO"]));				//??????????????

	/*???????(????) ???? ??? ????*/
	$agspay->SetValue("ICHE_SOCKETYN",trim($_POST["ICHE_SOCKETYN"]));			//???????(????) ??? ????
	$agspay->SetValue("ICHE_POSMTID",trim($_POST["ICHE_POSMTID"]));				//???????(????) ???????????
	$agspay->SetValue("ICHE_FNBCMTID",trim($_POST["ICHE_FNBCMTID"]));			//???????(????) FNBC??????
	$agspay->SetValue("ICHE_APTRTS",trim($_POST["ICHE_APTRTS"]));				//???????(????) ??? ?ð?
	$agspay->SetValue("ICHE_REMARK1",trim($_POST["ICHE_REMARK1"]));				//???????(????) ???????1
	$agspay->SetValue("ICHE_REMARK2",trim($_POST["ICHE_REMARK2"]));				//???????(????) ???????2
	$agspay->SetValue("ICHE_ECWYN",trim($_POST["ICHE_ECWYN"]));					//???????(????) ??????ο???
	$agspay->SetValue("ICHE_ECWID",trim($_POST["ICHE_ECWID"]));					//???????(????) ???????ID
	$agspay->SetValue("ICHE_ECWAMT1",trim($_POST["ICHE_ECWAMT1"]));				//???????(????) ?????????????1
	$agspay->SetValue("ICHE_ECWAMT2",trim($_POST["ICHE_ECWAMT2"]));				//???????(????) ?????????????2
	$agspay->SetValue("ICHE_CASHYN",trim($_POST["ICHE_CASHYN"]));				//???????(????) ???????????????
	$agspay->SetValue("ICHE_CASHGUBUN_CD",trim($_POST["ICHE_CASHGUBUN_CD"]));	//???????(????) ?????????????
	$agspay->SetValue("ICHE_CASHID_NO",trim($_POST["ICHE_CASHID_NO"]));			//???????(????) ??????????????ι??

	/*???????-??????(????) ???? ??? ????*/
	$agspay->SetValue("ICHEARS_SOCKETYN", trim($_POST["ICHEARS_SOCKETYN"]));	//?????????????(????) ??? ????
	$agspay->SetValue("ICHEARS_ADMNO", trim($_POST["ICHEARS_ADMNO"]));			//????????????? ???ι??       
	$agspay->SetValue("ICHEARS_POSMTID", trim($_POST["ICHEARS_POSMTID"]));		//????????????? ???????????
	$agspay->SetValue("ICHEARS_CENTERCD", trim($_POST["ICHEARS_CENTERCD"]));	//????????????? ???????      
	$agspay->SetValue("ICHEARS_HPNO", trim($_POST["ICHEARS_HPNO"]));			//????????????? ????????   
	
	/****************************************************************************
	*
	* [4] ???????? ?????????? ?????? ???????.
	*
	****************************************************************************/
	$agspay->startPay();

	
	/****************************************************************************
	*
	* [5] ????????? ???? ????DB ???? ?? ??? ????? ???????? ??????? ?κ?????.
	*
	*	????? ????????? ????? ?? ????????? ??????????? ?????? ?? ??????.
	*	
	*	-- ?????? --
	*	???ID : $agspay->GetResult("rStoreId")
	*	?????? : $agspay->GetResult("rOrdNo")
	*	????? : $agspay->GetResult("rProdNm")
	*	?????? : $agspay->GetResult("rAmt")
	*	???????? : $agspay->GetResult("rSuccYn") (????:y ????:n)
	*	???????? : $agspay->GetResult("rResMsg")
	*
	*	1. ??????
	*	
	*	??????? : $agspay->GetResult("rBusiCd")
	*	?????? : $agspay->GetResult("rDealNo")
	*	???ι?? : $agspay->GetResult("rApprNo")
	*	?????? : $agspay->GetResult("rInstmt")
	*	???νð? : $agspay->GetResult("rApprTm")
	*	??????? : $agspay->GetResult("rCardCd")
	*
	*	2.???????(???????/??????)
	*	????????????? : $agspay->GetResult("ES_SENDNO") (??????? ??????)
	*
	*	3.???????
	*	????????? ?????????? ??????¹???? ???????? ?????? ???????·? ???? ???? ????? ????? ???? ?????.
	*	???? ??????? ???????? ???????? ?????? ????? ?????ø? ?????.
	*	?????? ???? ?????? ???·? ????? ????? MallPage(???? ????? ??????(???????))?? ??????? ??????
	*	??? ??μ? ?????? ????? ???? ??????? ???? ???(????? ??)??  MallPage?? ????????? ????.
	*	???????? : $agspay->GetResult("rAuthTy")
	*	???????? : $agspay->GetResult("rApprTm")
	*	??????¹?? : $agspay->GetResult("rVirNo")
	*
	*	4.?????????
	*	??????????? : $agspay->GetResult("rHP_DATE")
	*	????????? TID : $agspay->GetResult("rHP_TID")
	*
	*	5.ARS????
	*	ARS?????? : $agspay->GetResult("rHP_DATE")
	*	ARS???? TID : $agspay->GetResult("rHP_TID")
	*
	****************************************************************************/
	
	if($agspay->GetResult("rSuccYn") == "y")
	{ 
		if($agspay->GetResult("AuthTy") == "virtual"){
			//??????°????? ??? ????? ?????? ???? ????????(??????? ??????)???? ????? ?????ø? ?????. 

		}else{
			// ?????????? ???? ????????κ?
			//echo ("?????? ???????????????. [" . $agspay->GetResult("rSuccYn")."]". $agspay->GetResult("rResMsg").". " );
		}
	}
	else
	{
		// ???????п? ???? ????????κ?
		//echo ("?????? ???????????????. [" . $agspay->GetResult("rSuccYn")."]". $agspay->GetResult("rResMsg").". " );
	}
	

	/*******************************************************************
	* [6] ?????? ??????????? ?????? ??? $agspay->GetResult("NetCancID") ???? ??????                                     
	* ????????? ???? ????ο???? ?? ?? ??????.
	* 
	* ??? ???????????? ??????? ?????? ??????????? ????? ??쿡?? ??????? ??????. 
	*
	* ????? :
	* $agspay->checkPayResult($agspay->GetResult("NetCancID"));
	*                           
	*******************************************************************/
	
	/*
	$agspay->SetValue("Type", "Pay"); // ????
	$agspay->checkPayResult($agspay->GetResult("NetCancID"));
	*/
	
	/*******************************************************************
	* [7] ????DB ???? ?? ??? ?????? ??????н? ???????                                      
	*   
	* $cancelReq : "true" ??????????, "false" ?????????????.
	*
	* ????????? ???? ????????κ? ???? ?? ??????? ???    
	* ????? ??? ??????? ????? ????? ?? ??????.
	*	?????????? : $agspay->GetResult("rCancelSuccYn") (????:y ????:n)
	*	?????????? : $agspay->GetResult("rCancelResMsg")
	*
	* ??????? :
	* ???????(virtual)?? ??????? ????? ???????? ??????.
	*******************************************************************/
	
	// ????????κ? ??????н? $cancelReq?? "true"?? ??????? 
	// ???????? ???????? ?? ?? ??????.
	// $cancelReq?? "true"?????? ?????????? ???????? ??????? ????.
	
	/*
	$cancelReq = "false";

	if($cancelReq == "true")
	{
		$agspay->SetValue("Type", "Cancel"); // ????
		$agspay->SetValue("CancelMsg", "DB FAIL"); // ??????
		$agspay->startPay();
	}
	*/
	

?>
<html>
<head>
</head>
<body onload="javascript:frmAGS_pay_ing.submit();">
<form name=frmAGS_pay_ing method=post action=AGS_pay_result.php>

<!-- ?? ???? ???? ??? ???? -->
<input type=hidden name=AuthTy value="<?=$agspay->GetResult("AuthTy")?>">		<!-- ???????? -->
<input type=hidden name=SubTy value="<?=$agspay->GetResult("SubTy")?>">			<!-- ??????????? -->
<input type=hidden name=rStoreId value="<?=$agspay->GetResult("rStoreId")?>">	<!-- ????????? -->
<input type=hidden name=rOrdNo value="<?=$agspay->GetResult("rOrdNo")?>">		<!-- ?????? -->
<input type=hidden name=rProdNm value="<?=$agspay->GetResult("ProdNm")?>">		<!-- ????? -->
<input type=hidden name=rAmt value="<?=$agspay->GetResult("rAmt")?>">			<!-- ??????? -->
<input type=hidden name=rOrdNm value="<?=$agspay->GetResult("OrdNm")?>">		<!-- ?????? -->
<input type=hidden name=AGS_HASHDATA value="<?=$AGS_HASHDATA?>">				<!-- ???? HASHDATA -->

<input type=hidden name=rSuccYn value="<?=$agspay->GetResult("rSuccYn")?>">	<!-- ???????? -->
<input type=hidden name=rResMsg value="<?=$agspay->GetResult("rResMsg")?>">	<!-- ???????? -->
<input type=hidden name=rApprTm value="<?=$agspay->GetResult("rApprTm")?>">	<!-- ?????ð? -->

<!-- ?????? ???? ??? ???? -->
<input type=hidden name=rBusiCd value="<?=$agspay->GetResult("rBusiCd")?>">		<!-- (?????????)??????? -->
<input type=hidden name=rApprNo value="<?=$agspay->GetResult("rApprNo")?>">		<!-- (?????????)???ι?? -->
<input type=hidden name=rCardCd value="<?=$agspay->GetResult("rCardCd")?>">	<!-- (?????????)??????? -->
<input type=hidden name=rDealNo value="<?=$agspay->GetResult("rDealNo")?>">			<!-- (?????????)?????? -->

<input type=hidden name=rCardNm value="<?=$agspay->GetResult("rCardNm")?>">	<!-- (??????,?????)????? -->
<input type=hidden name=rMembNo value="<?=$agspay->GetResult("rMembNo")?>">	<!-- (??????,?????)????????? -->
<input type=hidden name=rAquiCd value="<?=$agspay->GetResult("rAquiCd")?>">		<!-- (??????,?????)???????? -->
<input type=hidden name=rAquiNm value="<?=$agspay->GetResult("rAquiNm")?>">	<!-- (??????,?????)?????? -->

<!-- ??????? ???? ??? ???? -->
<input type=hidden name=ICHE_OUTBANKNAME value="<?=$agspay->GetResult("ICHE_OUTBANKNAME")?>">		<!-- ???????? -->
<input type=hidden name=ICHE_OUTBANKMASTER value="<?=$agspay->GetResult("ICHE_OUTBANKMASTER")?>">	<!-- ??????¿????? -->
<input type=hidden name=ICHE_AMOUNT value="<?=$agspay->GetResult("ICHE_AMOUNT")?>">					<!-- ?????? -->

<!-- ????? ???? ??? ???? -->
<input type=hidden name=rHP_HANDPHONE value="<?=$agspay->GetResult("HP_HANDPHONE")?>">		<!-- ???????? -->
<input type=hidden name=rHP_COMPANY value="<?=$agspay->GetResult("HP_COMPANY")?>">			<!-- ?????(SKT,KTF,LGT) -->
<input type=hidden name=rHP_TID value="<?=$agspay->GetResult("rHP_TID")?>">					<!-- ????TID -->
<input type=hidden name=rHP_DATE value="<?=$agspay->GetResult("rHP_DATE")?>">				<!-- ???????? -->

<!-- ARS ???? ??? ???? -->
<input type=hidden name=rARS_PHONE value="<?=$agspay->GetResult("ARS_PHONE")?>">			<!-- ARS??? -->

<!-- ??????? ???? ??? ???? -->
<input type=hidden name=rVirNo value="<?=$agspay->GetResult("rVirNo")?>">					<!-- ??????¹?? -->
<input type=hidden name=VIRTUAL_CENTERCD value="<?=$agspay->GetResult("VIRTUAL_CENTERCD")?>">	<!--????????????????(??????:20) -->

<!-- ??????? ???? ??? ???? -->
<input type=hidden name=ES_SENDNO value="<?=$agspay->GetResult("ES_SENDNO")?>">				<!-- ???????(???????) -->

</form>
</body> 
</html>